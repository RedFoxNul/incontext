<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0b0e" />
  <title>Farsi Practice Lab — Ink & Paper</title>
  <style>
    /*
      INK & PAPER
      - Light mode: warm paper + subtle fiber
      - Dark mode: ink-wash charcoal + grain
      - Tactile: press depth + snap transitions
    */

    :root{
      --bg:#0b0b0e;
      --panel: rgba(18,18,22,0.88);
      --modalPanel: rgba(18,18,22,0.97);
      --ink:#ececf2;
      --muted:#a8a8b6;
      --line:#2a2a33;
      --accent:#3b82f6;
      --shadow: rgba(0,0,0,0.55);
      --shadowHard: rgba(0,0,0,0.28);
      --paperTint: rgba(255,255,255,0.08);
      --btnBg: rgba(0,0,0,0.22);
      --btnBg2: rgba(59,130,246,0.12);
      --kbdBg: rgba(0,0,0,0.28);
      --toastBg: rgba(0,0,0,0.22);
      --modalBg: rgba(0,0,0,0.52);
    }

    :root[data-theme="light"]{
      --bg:#f6f2ea;
      --panel: rgba(255,255,255,0.78);
      --modalPanel: rgba(255,255,255,0.94);
      --ink:#14161d;
      --muted:#4b5563;
      --line:#d6d0c6;
      --accent:#2563eb;
      --shadow: rgba(17,19,24,0.16);
      --shadowHard: rgba(17,19,24,0.10);
      --paperTint: rgba(20,22,29,0.04);
      --btnBg: rgba(255,255,255,0.55);
      --btnBg2: rgba(37,99,235,0.10);
      --kbdBg: rgba(255,255,255,0.55);
      --toastBg: rgba(255,255,255,0.55);
      --modalBg: rgba(20,22,29,0.34);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      color:var(--ink);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;
      background: var(--bg);

      background-image:
        radial-gradient(1200px 720px at 18% 2%, var(--paperTint), transparent 60%),
        radial-gradient(980px 640px at 85% 18%, rgba(59,130,246,0.07), transparent 62%),
        repeating-linear-gradient(0deg, rgba(255,255,255,0.025) 0px, rgba(255,255,255,0.025) 1px, transparent 2px, transparent 7px),
        repeating-linear-gradient(90deg, rgba(0,0,0,0.02) 0px, rgba(0,0,0,0.02) 1px, transparent 2px, transparent 9px);
    }

    :root[data-theme="light"] body{
      background-image:
        radial-gradient(1200px 720px at 18% 2%, rgba(20,22,29,0.035), transparent 62%),
        radial-gradient(980px 640px at 85% 18%, rgba(37,99,235,0.05), transparent 66%),
        repeating-linear-gradient(0deg, rgba(20,22,29,0.018) 0px, rgba(20,22,29,0.018) 1px, transparent 2px, transparent 8px),
        repeating-linear-gradient(90deg, rgba(20,22,29,0.012) 0px, rgba(20,22,29,0.012) 1px, transparent 2px, transparent 10px);
    }

    .wrap{ min-height:100%; display:flex; justify-content:center; padding:24px; }
    .app{ width:min(1040px, 100%); display:flex; flex-direction:column; gap:16px; }

    .topbar{
      border:1px solid var(--line);
      background: var(--panel);
      padding:14px 16px;
      border-radius:0;
      box-shadow: 0 12px 40px var(--shadow);
      position:relative;
      overflow:hidden;
    }

    .topbar::before{
      content:"";
      position:absolute;
      inset:-1px;
      pointer-events:none;
      opacity:0.35;
      background:
        radial-gradient(720px 280px at 36% 0%, rgba(59,130,246,0.14), transparent 60%),
        radial-gradient(900px 420px at 0% 85%, rgba(255,255,255,0.05), transparent 60%);
      mix-blend-mode: multiply;
    }

    :root[data-theme="dark"] .topbar::before{ mix-blend-mode: screen; opacity:0.26; }

    header{ position:relative; z-index:1; display:flex; gap:12px; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; min-width:0; }

    .brand{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    .brand h1{ margin:0; font-size:22px; letter-spacing:0.2px; font-weight:800; }
    .brand p{ margin:0; color:var(--muted); font-size:13px; max-width:62ch; }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; max-width:100%; min-width:0; }

    .pill{
      border:1px solid var(--line);
      background: rgba(0,0,0,0.08);
      padding:6px 10px;
      border-radius:0;
      color:var(--muted);
      font-size:13px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      user-select:none;
      max-width:100%;
      min-width:0;
    }

    :root[data-theme="dark"] .pill{ background: rgba(0,0,0,0.20); }

    .kbd{
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      font-size:12px;
      padding:1px 6px;
      border:1px solid var(--line);
      background: var(--kbdBg);
      border-radius:0;
      color:var(--muted);
    }

    .grid{ display:grid; grid-template-columns: 1.2fr 0.8fr; gap:16px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

    /* Small screens: prevent header controls from overflowing */
    @media (max-width: 520px){
      .wrap{ padding:14px; }
      .topbar{ padding:12px 12px; }
      header{ gap:10px; }
      .controls{ width:100%; justify-content:flex-start; }
      .pill{ width:100%; }
      #themeBtn{ width:100%; justify-content:center; }
    }

    .panel{
      border:1px solid var(--line);
      background: var(--panel);
      padding:16px;
      border-radius:0;
      box-shadow: 0 10px 30px var(--shadow);
      position:relative;
      overflow:hidden;
    }

    .panel::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0.08;
      background: repeating-linear-gradient(0deg, rgba(0,0,0,0.10) 0px, rgba(0,0,0,0.10) 1px, transparent 2px, transparent 12px);
    }

    :root[data-theme="dark"] .panel::after{ opacity:0.06; }

    .label{ color:var(--muted); text-transform:uppercase; font-size:12px; letter-spacing:0.2px; margin-bottom:10px; position:relative; z-index:1; }

    .hero{ display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap; position:relative; z-index:1; }
    .heroText{ min-width: 260px; flex: 1 1 420px; }

    .heroText h2{ margin:0; font-size:30px; line-height:1.1; letter-spacing:0.2px; }
    .heroText h2 .accent{ color:var(--accent); }

    .heroText p{ margin:10px 0 0; color:var(--muted); max-width:60ch; }

    .cta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; flex: 1 1 340px; }

    .btn{
      border:1px solid var(--line);
      background: var(--btnBg);
      color:var(--ink);
      padding:12px 14px;
      border-radius:0;
      cursor:pointer;
      font:inherit;
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
      transition: transform 120ms ease, border-color 120ms ease, background 120ms ease, box-shadow 120ms ease;
      box-shadow: 0 10px 0 var(--shadowHard);
      touch-action: manipulation;
    }

    a.btn{ text-decoration:none; }

    .btn.primary{ border-color: color-mix(in srgb, var(--accent) 60%, var(--line)); background: var(--btnBg2); }
    .btn:hover{ transform: translateY(-1px); border-color: color-mix(in srgb, var(--accent) 70%, var(--line)); }
    .btn:active{ transform: translateY(3px); box-shadow: 0 6px 0 var(--shadowHard); }

    .btn .dot{ width:10px; height:10px; border:1px solid var(--line); background: color-mix(in srgb, var(--accent) 22%, transparent); display:inline-block; }

    /* Big navigation buttons */
    .navStack{ display:flex; flex-direction:column; gap:10px; position:relative; z-index:1; }
    .navBtn{ width:100%; justify-content:space-between; padding:14px 14px; }
    .navLeft{ display:flex; gap:10px; align-items:center; }

    .badge{ font-size:12px; color:var(--muted); border:1px solid var(--line); background: rgba(0,0,0,0.06); padding:3px 8px; }
    :root[data-theme="dark"] .badge{ background: rgba(0,0,0,0.18); }

    .toast{
      border:1px solid var(--line);
      background: var(--toastBg);
      padding:10px 12px;
      min-height: 44px; /* reserved space -> no jitter */
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:12px;
      color:var(--muted);
      position:relative;
      z-index:1;
    }
    .toast strong{ color:var(--ink); font-weight:700; }

    .note{ color:var(--muted); font-size:13px; margin-top:10px; position:relative; z-index:1; }

    /* Modal (Options only, for now) */
    .backdrop{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: var(--modalBg);
      z-index:999;
    }
    .backdrop.show{ display:flex; }

    .modal{
      width:min(620px, 100%);
      border:1px solid var(--line);
      background: var(--modalPanel); /* <— more opaque to avoid “transparent modal” weirdness */
      border-radius:0;
      box-shadow: 0 20px 60px var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .modalHeader{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .modalHeader .title{ font-weight:800; letter-spacing:0.2px; }

    .modalBody{ padding:14px; display:flex; flex-direction:column; gap:12px; }

    .field{
      border:1px solid var(--line);
      background: rgba(0,0,0,0.06);
      padding:12px;
    }
    :root[data-theme="dark"] .field{ background: rgba(0,0,0,0.18); }

    .row{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }

    .field label{ color:var(--muted); font-size:13px; }

    input[type="range"]{ width: min(320px, 100%); }

    .radioRow{ display:flex; gap:10px; flex-wrap:wrap; }

    .closeX{
      border:1px solid var(--line);
      background: rgba(0,0,0,0.10);
      color:var(--ink);
      width:36px;
      height:36px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
    }
    :root[data-theme="dark"] .closeX{ background: rgba(0,0,0,0.22); }

    .closeX:active{ transform: translateY(1px); }

    /* Respect reduced-motion */
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important; }
      .btn:hover{ transform:none !important; }
      .btn:active{ transform:none !important; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app">

      <div class="topbar">
        <header>
          <div class="brand">
            <h1>In context: A Farsi Practice Lab by سیامک</h1>
            <p>Ink & Paper home: clean launch pad + sane defaults. We’re keeping it snappy, not bureaucratic.</p>
          </div>
          <div class="controls">
            <div class="pill">
              <span class="kbd">D</span> theme • <span class="kbd">Q</span> quickstart • <span class="kbd">S</span> decks • <span class="kbd">L</span> lessons • <span class="kbd">O</span> options
            </div>
            <button class="btn" id="themeBtn" type="button" aria-label="Toggle theme"><span class="dot"></span><span id="themeBtnText">Theme</span></button>
          </div>
        </header>
      </div>

      <div class="grid">
        <section class="panel">
          <div class="label">Home</div>

          <div class="hero">
            <div class="heroText">
              <h2>Practice vocab in <span class="accent">context</span>.</h2>
              <p id="welcomeMsg">$REF{SELECT_WELCOME_MESSAGE}</p>
            </div>
            <div class="cta">
              <a class="btn" id="selectDeckBtn" href="./decks/index.html"><span class="dot"></span>select decks</a>
              <button class="btn" id="optionsBtn" type="button"><span class="dot"></span>Options</button>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="label">Navigation</div>
          <div class="navStack">
            <a class="btn navBtn primary" id="navQuickstart" href="./quiz/index.html">
              <span class="navLeft"><span class="dot"></span>Quickstart</span>
              <span class="badge">last deck</span>
            </a>
            <a class="btn navBtn" id="navSelectDeck" href="./decks/index.html">
              <span class="navLeft"><span class="dot"></span>select decks</span>
              <span class="badge">choose</span>
            </a>
            <a class="btn navBtn" id="navLessons" href="./lessons/index.html">
              <span class="navLeft"><span class="dot"></span>Lessons</span>
              <span class="badge">roots + syntax</span>
            </a>
            <a class="btn navBtn" id="navResources" href="./resources/index.html">
              <span class="navLeft"><span class="dot"></span>Other resources</span>
              <span class="badge">directory</span>
            </a>
            <button class="btn navBtn" id="navOptions" type="button">
              <span class="navLeft"><span class="dot"></span>Options</span>
              <span class="badge">tweak</span>
            </button>
          </div>

          <div style="height:12px"></div>

          <div class="toast" id="toast">
            <span><strong>Ready.</strong> Pick where to go.</span>
          </div>

          <div class="note" id="note"></div>
        </section>

        <aside class="panel">
          <div class="label">Status</div>
          <div class="navStack">
            <div class="field" id="statusDeck">
              <div class="row"><label>Last selected deck</label><span class="badge" id="lastDeckBadge">—</span></div>
              <div style="height:8px"></div>
              <div style="color:var(--muted); font-size:13px;" id="lastDeckDesc">Pick a deck to enable quickstart.</div>
            </div>

            <div class="field" id="statusOpts">
              <div class="row"><label>Practice settings</label><span class="badge" id="optsBadge">—</span></div>
              <div style="height:8px"></div>
              <div style="color:var(--muted); font-size:13px;" id="optsDesc">Timer + haptics live under Options.</div>
            </div>

            <div class="field">
              <div class="row"><label>Keyboard</label><span class="badge">shortcuts</span></div>
              <div style="height:8px"></div>
              <div style="color:var(--muted); font-size:13px;">
                <span class="kbd">D</span> theme • <span class="kbd">Q</span> quickstart • <span class="kbd">S</span> decks • <span class="kbd">L</span> lessons • <span class="kbd">O</span> options
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Options Modal (kept for now) -->
  <div class="backdrop" id="optionsBackdrop" role="dialog" aria-modal="true" aria-label="Options">
    <div class="modal">
      <div class="modalHeader">
        <div class="title">Options</div>
        <button class="closeX" type="button" id="optionsClose" aria-label="Close">✕</button>
      </div>
      <div class="modalBody">
        <div class="field">
          <div class="row"><label>Timer</label><span class="badge" id="timerBadge">—</span></div>
          <div style="height:10px"></div>
          <div class="row">
            <label><input type="checkbox" id="timerEnabled" /> Enable timer</label>
            <span style="color:var(--muted); font-size:13px;">Per-question countdown</span>
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <label>Seconds: <strong id="timerValue">10</strong>s</label>
            <input type="range" id="timerSeconds" min="3" max="60" step="1" />
          </div>
        </div>

        <div class="field">
          <div class="row"><label>Haptics</label><span class="badge" id="hapticsBadge">—</span></div>
          <div style="height:10px"></div>
          <div class="row">
            <label><input type="checkbox" id="hapticsEnabled" /> Enable vibration</label>
            <span style="color:var(--muted); font-size:13px;" id="hapticsSupport">—</span>
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <label>Strength</label>
            <div class="radioRow" role="radiogroup" aria-label="Haptic strength">
              <label><input type="radio" name="hStrength" value="1" /> Light</label>
              <label><input type="radio" name="hStrength" value="2" /> Medium</label>
              <label><input type="radio" name="hStrength" value="3" /> Heavy</label>
            </div>
          </div>
        </div>

        <div class="note">These values persist in <span class="kbd">localStorage</span> so your quiz page can read them later.</div>
      </div>
    </div>
  </div>

  <script>
    // --- Keys (shared with quiz page later) ---
    const THEME_KEY = "fpl_theme";
    const LAST_DECK_KEY = "fpl_lastDeck";

    // --- Welcome message (random per visit) ---
    const WELCOME_TOKEN = "$REF{SELECT_WELCOME_MESSAGE}";
    const WELCOME_LAST_IDX_KEY = "fpl_welcomeLastIdx";

    // Edit these freely.
    const WELCOME_MESSAGES = [
      "Warm up your brain: pick a deck and go.",
      "New day, new words. Your future self will thank you, hopefully in farsi.",
      "Context is king. Vocab without sentences is just confetti.",
      "Two minutes now beats two hours of regret later.",
      "Pick a deck. Practice. Become mildly unstoppable.",
      "Failure is the path too mastery.",
      "حالا شروع کن — your only job is to start.",
      "If you can scroll, you can study. Tragic but true.",
      "Small wins stack. One deck at a time.",
      "Back for more?",
      "It's good to see you again!",
      "Ready to give your goals the persian fist?",
      "Another day, another deck.",
      "Glad you're back! Ready to get smarter?",
    ];

    function setRandomWelcomeMessage(){
      const el = document.getElementById("welcomeMsg");
      if(!el) return;

      const current = (el.textContent || "").trim();
      const shouldReplace =
        current === "" ||
        current.includes("SELECT_WELCOME_MESSAGE") ||
        current.includes(WELCOME_TOKEN);

      if(!shouldReplace) return;

      const n = WELCOME_MESSAGES.length;
      if(n === 0) return;

      const lastRaw = lsGet(WELCOME_LAST_IDX_KEY, "-1");
      const lastIdx = Number.isFinite(parseInt(lastRaw, 10)) ? parseInt(lastRaw, 10) : -1;

      let idx = Math.floor(Math.random() * n);
      if(n > 1 && idx === lastIdx){
        // Avoid repeating the previous message.
        idx = (idx + 1 + Math.floor(Math.random() * (n - 1))) % n;
      }

      lsSet(WELCOME_LAST_IDX_KEY, String(idx));

      const lastDeck = getLastDeck();
      const deckName = lastDeck ? lastDeck.name : "a deck";
      const msg = String(WELCOME_MESSAGES[idx]).replaceAll("{deck}", deckName);

      el.textContent = msg;
    }

    const TIMER_ENABLED_KEY = "fvq_timerEnabled";
    const TIMER_SECONDS_KEY = "fvq_timerSeconds";

    const HAPTICS_ENABLED_KEY = "fpl_hapticsEnabled";
    const HAPTICS_STRENGTH_KEY = "fpl_hapticsStrength";

    // --- Theme ---
    function getSystemTheme(){
      try{ return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light"; }
      catch { return "dark"; }
    }

    function setMetaThemeColor(theme){
      const meta = document.querySelector('meta[name="theme-color"]');
      if(!meta) return;
      meta.setAttribute("content", theme === "light" ? "#f6f2ea" : "#0b0b0e");
    }

    function applyTheme(theme){
      document.documentElement.dataset.theme = theme;
      setMetaThemeColor(theme);
      const t = document.getElementById("themeBtnText");
      if(t) t.textContent = theme === "light" ? "Theme: Light" : "Theme: Dark";
    }

    function loadTheme(){
      let saved = null;
      try{ saved = localStorage.getItem(THEME_KEY); } catch {}
      applyTheme(saved || getSystemTheme());
    }

    function toggleTheme(){
      const cur = document.documentElement.dataset.theme || "dark";
      const next = cur === "dark" ? "light" : "dark";
      applyTheme(next);
      try{ localStorage.setItem(THEME_KEY, next); } catch {}
    }

    // --- Storage helpers ---
    function lsGet(key, fallback){
      try{ const v = localStorage.getItem(key); return v === null ? fallback : v; } catch { return fallback; }
    }
    function lsSet(key, value){
      try{ localStorage.setItem(key, value); } catch { /* ignore */ }
    }

    // --- Haptics ---
    let hapticsEnabled = true;
    let strength = 2;

    const supportsVibrate = typeof navigator !== "undefined" && typeof navigator.vibrate === "function";

    function haptic(kind = "tap"){
      if(!hapticsEnabled) return;
      if(!supportsVibrate) return;

      // Treat generic taps as “strength-weighted” taps.
      let resolved = kind;
      if(kind === "tap"){
        resolved = strength === 1 ? "light" : strength === 2 ? "med" : "heavy";
      }

      const patterns = {
        light: [10],
        med: [18],
        heavy: [25],
        success: [12, 30, 12],
        warn: [20, 40, 20]
      };

      const p = patterns[resolved] || patterns.med;
      try{ navigator.vibrate(p); } catch {}
    }

    function loadHaptics(){
      hapticsEnabled = lsGet(HAPTICS_ENABLED_KEY, "1") === "1";
      const raw = parseInt(lsGet(HAPTICS_STRENGTH_KEY, "2"), 10);
      strength = Number.isFinite(raw) ? Math.max(1, Math.min(3, raw)) : 2;
    }

    function setHapticsEnabled(on){
      hapticsEnabled = !!on;
      lsSet(HAPTICS_ENABLED_KEY, hapticsEnabled ? "1" : "0");
      updateStatus();
    }

    function setStrength(n){
      strength = Math.max(1, Math.min(3, n));
      lsSet(HAPTICS_STRENGTH_KEY, String(strength));
      updateStatus();
      haptic("tap");
    }

    // --- Timer options ---
    function loadTimer(){
      const enabled = lsGet(TIMER_ENABLED_KEY, "0") === "1";
      const raw = parseInt(lsGet(TIMER_SECONDS_KEY, "10"), 10);
      const seconds = Number.isFinite(raw) ? Math.max(3, Math.min(60, raw)) : 10;
      return { enabled, seconds };
    }

    function saveTimer(enabled, seconds){
      lsSet(TIMER_ENABLED_KEY, enabled ? "1" : "0");
      lsSet(TIMER_SECONDS_KEY, String(Math.max(3, Math.min(60, seconds))));
      updateStatus();
    }

    // --- Deck data (used for status + quickstart link building) ---
    const decks = [
      { id: "vocab-ramadan", name: "Vocab: Ramadan set", desc: "Fast core vocab + culture terms." },
      { id: "vocab-marriage", name: "Vocab: Marriage set", desc: "Engagement/wedding vocabulary." },
      { id: "roots-intro", name: "Roots: Arabic patterns (intro)", desc: "Measures/patterns: the lego rules." },
    ];

    function getLastDeck(){
      const id = lsGet(LAST_DECK_KEY, "");
      return decks.find(d => d.id === id) || null;
    }

    // --- UI helpers ---
    const $ = (s) => document.querySelector(s);

    function toast(html){
      $("#toast").innerHTML = `<span>${html}</span>`;
    }

    // --- Modals (Options only) ---
    function openOptions(){
      syncOptionsUI();
      haptic("tap");
      $("#optionsBackdrop").classList.add("show");
    }

    function closeOptions(){
      $("#optionsBackdrop").classList.remove("show");
    }

    // --- Status UI ---
    function updateQuickstartHref(){
      const last = getLastDeck();
      const qs = $("#navQuickstart");
      if(!qs) return;

      // If no last deck, send them to the decks page (once it exists)
      if(!last){
        qs.href = "./decks/index.html";
        return;
      }

      // Future-proof: quiz can read deck=... from query
      qs.href = `./quiz/index.html?deck=${encodeURIComponent(last.id)}`;
    }

    function updateStatus(){
      const last = getLastDeck();
      $("#lastDeckBadge").textContent = last ? last.name : "None";
      $("#lastDeckDesc").textContent = last ? last.desc : "Pick a deck to enable quickstart.";

      const t = loadTimer();
      const hOn = hapticsEnabled && supportsVibrate;
      const opts = `Timer ${t.enabled ? t.seconds + "s" : "off"} • Haptics ${hOn ? (strength===1?"light":strength===2?"med":"heavy") : "off"}`;
      $("#optsBadge").textContent = opts;
      $("#optsDesc").textContent = "Options persist locally; your quiz page can read them.";

      updateQuickstartHref();
    }

    // --- Options modal sync ---
    function syncOptionsUI(){
      // Timer
      const t = loadTimer();
      const timerEnabled = $("#timerEnabled");
      const timerSeconds = $("#timerSeconds");
      const timerValue = $("#timerValue");
      const timerBadge = $("#timerBadge");

      timerEnabled.checked = t.enabled;
      timerSeconds.value = String(t.seconds);
      timerValue.textContent = String(t.seconds);
      timerBadge.textContent = t.enabled ? `${t.seconds}s` : "Off";

      // Haptics
      const he = $("#hapticsEnabled");
      const hb = $("#hapticsBadge");
      const hs = $("#hapticsSupport");

      he.checked = hapticsEnabled;
      hs.textContent = supportsVibrate ? "Supported" : "Not supported";
      hb.textContent = hapticsEnabled ? (strength===1?"Light":strength===2?"Medium":"Heavy") : "Off";

      const radios = Array.from(document.querySelectorAll('input[name="hStrength"]'));
      radios.forEach(r => r.checked = Number(r.value) === strength);
    }

    function wireOptionsUI(){
      // Timer
      $("#timerEnabled").addEventListener("change", (e) => {
        const t = loadTimer();
        saveTimer(e.target.checked, t.seconds);
        haptic("tap");
        syncOptionsUI();
      });

      $("#timerSeconds").addEventListener("input", (e) => {
        const sec = parseInt(e.target.value, 10);
        const enabled = $("#timerEnabled").checked;
        saveTimer(enabled, sec);
        $("#timerValue").textContent = String(sec);
        $("#timerBadge").textContent = enabled ? `${sec}s` : "Off";
      });

      $("#timerSeconds").addEventListener("change", () => {
        haptic("tap");
        syncOptionsUI();
      });

      // Haptics
      $("#hapticsEnabled").addEventListener("change", (e) => {
        setHapticsEnabled(e.target.checked);
        haptic("tap");
        syncOptionsUI();
      });

      const radios = Array.from(document.querySelectorAll('input[name="hStrength"]'));
      radios.forEach((r) => {
        r.addEventListener("change", () => {
          if(r.checked) setStrength(parseInt(r.value, 10));
          syncOptionsUI();
        });
      });
    }

    // --- Init ---
    loadTheme();
    loadHaptics();
    updateStatus();
    setRandomWelcomeMessage();

    $("#note").textContent = supportsVibrate
      ? "Haptics supported. Settings live in Options and persist locally."
      : "This browser probably won’t vibrate (common on iOS Safari). Everything else still works.";

    toast(`<strong>Ready.</strong> Last deck: ${getLastDeck() ? getLastDeck().name : "none"}.`);

    // Theme button
    $("#themeBtn").addEventListener("click", () => { toggleTheme(); haptic("tap"); toast("Theme toggled."); });

    // Options opens modal (kept for now)
    $("#optionsBtn").addEventListener("click", openOptions);
    $("#navOptions").addEventListener("click", openOptions);

    // Options modal close
    $("#optionsClose").addEventListener("click", () => { haptic("tap"); closeOptions(); });
    $("#optionsBackdrop").addEventListener("click", (e) => {
      if(e.target === $("#optionsBackdrop")) { haptic("tap"); closeOptions(); }
    });

    // Options UI events
    wireOptionsUI();

    // Keyboard shortcuts (desktop power users, bless their souls)
    window.addEventListener("keydown", (e) => {
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
      if(tag === "input" || tag === "textarea" || tag === "select") return;

      const k = e.key.toLowerCase();
      if(k === "escape") closeOptions();
      if(k === "d") { toggleTheme(); haptic("tap"); toast("Theme toggled."); }
      if(k === "q") { window.location.href = $("#navQuickstart").href; }
      if(k === "s") { window.location.href = $("#navSelectDeck").href; }
      if(k === "l") { window.location.href = $("#navLessons").href; }
      if(k === "o") openOptions();
    });
  </script>
</body>
</html>
